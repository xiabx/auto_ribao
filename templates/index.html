<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œæ—¥æŠ¥ç”Ÿæˆå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.14/lib/index.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.14/lib/theme-chalk/index.css">
    <style>
        body { font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif; background-color: #f5f7fa; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: #fff; border-radius: 4px; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-day { height: 100%; padding: 5px; position: relative; overflow-y: auto; }
        .calendar-day.has-plan { background-color: #f0f9eb; }
        .calendar-day.is-holiday { background-color: #fef0f0; }
        .calendar-day .date-num { font-weight: bold; margin-bottom: 5px; }
        .calendar-day .plan-item { font-size: 12px; color: #666; margin-bottom: 2px; padding: 2px; background: rgba(255,255,255,0.5); border-radius: 2px; white-space: pre-wrap; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
        .calendar-day .holiday-tag { font-size: 10px; color: #f56c6c; position: absolute; top: 5px; right: 5px; }
        .el-calendar-table .el-calendar-day { height: 120px; }
        .form-container { max-width: 800px; }
        .logout-btn { float: right; }
        .plan-list-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .plan-list-item:last-child { border-bottom: none; }
        .result-dialog-content { text-align: center; padding: 20px; }
        .result-icon { font-size: 48px; margin-bottom: 15px; }
        .result-success { color: #67C23A; }
        .result-error { color: #F56C6C; }
        .result-message { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .result-detail { color: #666; font-size: 14px; white-space: pre-wrap; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 4px; margin-top: 10px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="card">
            <div class="header">
                <h2>ğŸ“… å·¥ä½œæ—¥æŠ¥ç”Ÿæˆå™¨</h2>
                <el-button type="text" class="logout-btn" @click="logout">é€€å‡ºç™»å½•</el-button>
            </div>

            <div class="form-container">
                <el-form :model="form" label-width="100px">
                    <el-form-item label="æ€»éœ€æ±‚æè¿°">
                        <el-input
                            type="textarea"
                            :rows="6"
                            v-model="form.requirement"
                            placeholder="è¯·è¾“å…¥è¯¦ç»†çš„éœ€æ±‚æè¿°"
                        ></el-input>
                    </el-form-item>
                    <el-form-item label="èµ·æ­¢æ—¥æœŸ">
                        <el-date-picker
                            v-model="form.dateRange"
                            type="daterange"
                            range-separator="è‡³"
                            start-placeholder="å¼€å§‹æ—¥æœŸ"
                            end-placeholder="ç»“æŸæ—¥æœŸ"
                            value-format="yyyy-MM-dd"
                            style="width: 100%;">
                        </el-date-picker>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="generatePlan" :loading="loading" style="width: 200px;">ç”Ÿæˆè®¡åˆ’</el-button>
                    </el-form-item>
                </el-form>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ—“ï¸ å·¥ä½œæ—¥å†</h3>
            <el-calendar v-model="currentDate">
                <template slot="dateCell" slot-scope="{date, data}">
                    {% raw %}
                    <div class="calendar-day"
                         :class="{
                             'has-plan': getPlansForDate(data.day).length > 0,
                             'is-holiday': isHoliday(data.day)
                         }"
                         @click="handleDateClick(data.day)">
                        <div class="date-num">{{ data.day.split('-').slice(2).join('') }}</div>

                        <div v-if="isHoliday(data.day)" class="holiday-tag">
                            {{ getHolidayName(data.day) }}
                        </div>

                        <div v-for="plan in getPlansForDate(data.day)" :key="plan.id" class="plan-item">
                            {{ plan.todo }}
                        </div>
                    </div>
                    {% endraw %}
                </template>
            </el-calendar>
        </div>

        <!-- æ—¥æŠ¥è¯¦æƒ…/ç¼–è¾‘å¯¹è¯æ¡† -->
        <el-dialog :title="currentDateStr + ' æ—¥æŠ¥è¯¦æƒ…'" :visible.sync="dialogVisible" width="60%">
            <div v-if="currentPlans.length === 0" style="text-align: center; color: #999; padding: 20px;">
                æš‚æ— è®¡åˆ’
            </div>
            <div v-else>
                <div v-for="(plan, index) in currentPlans" :key="plan.id" class="plan-list-item">
                    <el-form :model="plan" label-width="80px">
                        <el-form-item label="å·¥ä½œå†…å®¹">
                            <el-input type="textarea" v-model="plan.todo" rows="6"></el-input>
                        </el-form-item>
                        <el-form-item label="è¿›åº¦">
                            <el-input type="textarea" v-model="plan.progress" rows="2"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" size="small" @click="updatePlan(plan)">ä¿å­˜ä¿®æ”¹</el-button>
                            <el-button type="text" style="color: #f56c6c; margin-left: 10px;" @click="deletePlan(plan.id)">åˆ é™¤</el-button>
                        </el-form-item>
                    </el-form>
                </div>
            </div>
            <span slot="footer" class="dialog-footer">
                <el-button @click="dialogVisible = false">å…³ é—­</el-button>
            </span>
        </el-dialog>

        <!-- è®¡åˆ’é¢„è§ˆ/ç¡®è®¤å¯¹è¯æ¡† -->
        <el-dialog title="ç”Ÿæˆçš„è®¡åˆ’é¢„è§ˆ (å¯ç¼–è¾‘)" :visible.sync="previewDialogVisible" width="70%" :close-on-click-modal="false">
            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                <span style="font-weight: bold; margin-right: 15px;">å…¥åº“æ¨¡å¼ï¼š</span>
                <el-radio-group v-model="saveMode">
                    <el-radio label="overwrite">è¦†ç›–æ¨¡å¼ (æ¸…é™¤è¯¥æ—¶é—´æ®µåŸæœ‰è®¡åˆ’)</el-radio>
                    <el-radio label="append">è¿½åŠ æ¨¡å¼ (åœ¨åŸæœ‰å†…å®¹åè¿½åŠ )</el-radio>
                </el-radio-group>
            </div>
            <div style="max-height: 55vh; overflow-y: auto; padding-right: 10px;">
                {% raw %}
                <div v-for="(plan, index) in generatedPlans" :key="index" class="plan-list-item">
                    <el-form :model="plan" label-width="80px">
                        <el-tag size="medium" style="margin-bottom: 10px;">{{ plan.date }}</el-tag>
                        <el-form-item label="å·¥ä½œå†…å®¹">
                            <el-input type="textarea" v-model="plan.todo" rows="4"></el-input>
                        </el-form-item>
                        <el-form-item label="è¿›åº¦">
                            <el-input type="textarea" v-model="plan.progress" rows="2"></el-input>
                        </el-form-item>
                    </el-form>
                </div>
                {% endraw %}
            </div>
            <span slot="footer" class="dialog-footer">
                <el-button @click="previewDialogVisible = false">å– æ¶ˆ</el-button>
                <el-button type="primary" @click="confirmSavePlans" :loading="saving">ç¡®è®¤å…¥åº“</el-button>
            </span>
        </el-dialog>

        <!-- é”™è¯¯æç¤ºå¯¹è¯æ¡† -->
        <el-dialog
            title="ç”Ÿæˆå¤±è´¥"
            :visible.sync="errorDialogVisible"
            width="40%"
            center>
            <div class="result-dialog-content">
                <i class="el-icon-error result-icon result-error"></i>
                <div class="result-message result-error">è®¡åˆ’ç”Ÿæˆå¤±è´¥</div>
                <div class="result-detail">{{ generationErrorMsg }}</div>
            </div>
            <span slot="footer" class="dialog-footer">
                <el-button type="primary" @click="errorDialogVisible = false">ç¡® å®š</el-button>
            </span>
        </el-dialog>
    </div>

    <script>
        // æ·»åŠ å…¨å±€æ‹¦æˆªå™¨å¤„ç† 401
        axios.interceptors.response.use(response => {
            return response;
        }, error => {
            if (error.response && error.response.status === 401) {
                window.location.href = '/login';
            }
            return Promise.reject(error);
        });

        new Vue({
            el: '#app',
            data: {
                form: {
                    requirement: '',
                    dateRange: []
                },
                saveMode: 'overwrite', // é»˜è®¤è¦†ç›–æ¨¡å¼
                loading: false,
                saving: false,
                plans: [], // æ‰€æœ‰è®¡åˆ’åˆ—è¡¨
                holidays: {},
                currentDate: new Date(),
                dialogVisible: false,
                currentDateStr: '',
                currentPlans: [], // å½“å‰é€‰ä¸­æ—¥æœŸçš„è®¡åˆ’åˆ—è¡¨

                // é¢„è§ˆå¯¹è¯æ¡†
                previewDialogVisible: false,
                generatedPlans: [],

                // é”™è¯¯å¯¹è¯æ¡†
                errorDialogVisible: false,
                generationErrorMsg: ''
            },
            created() {
                this.fetchPlans();
                this.loadHolidaysForMonth(new Date());
            },
            watch: {
                currentDate(newDate) {
                    this.loadHolidaysForMonth(newDate);
                }
            },
            methods: {
                fetchPlans() {
                    axios.get('/api/get_plan').then(res => {
                        this.plans = res.data;
                    }).catch(console.error);
                },
                loadHolidaysForMonth(date) {
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const startDate = new Date(year, month, 1);
                    startDate.setDate(startDate.getDate() - 7);
                    const endDate = new Date(year, month + 1, 0);
                    endDate.setDate(endDate.getDate() + 7);

                    const startStr = this.formatDate(startDate);
                    const endStr = this.formatDate(endDate);

                    axios.get(`/api/get_holidays_batch?start_date=${startStr}&end_date=${endStr}`)
                        .then(res => {
                            this.holidays = { ...this.holidays, ...res.data };
                        })
                        .catch(console.error);
                },
                formatDate(date) {
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}`;
                },
                isHoliday(day) {
                    return !!this.holidays[day];
                },
                getHolidayName(day) {
                    return this.holidays[day];
                },
                generatePlan() {
                    if (!this.form.requirement || !this.form.dateRange || this.form.dateRange.length < 2) {
                        this.$message.error('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                        return;
                    }

                    this.loading = true;
                    // è°ƒç”¨ç”Ÿæˆæ¥å£ï¼ˆä»…é¢„è§ˆï¼Œä¸ä¿å­˜ï¼‰
                    axios.post('/api/generate_plan', {
                        requirement: this.form.requirement,
                        start_date: this.form.dateRange[0],
                        end_date: this.form.dateRange[1]
                    }).then(res => {
                        this.generatedPlans = res.data.plan;
                        this.previewDialogVisible = true;
                    }).catch(err => {
                        this.generationErrorMsg = err.response?.data?.error || err.message;
                        this.errorDialogVisible = true;
                    }).finally(() => {
                        this.loading = false;
                    });
                },
                confirmSavePlans() {
                    this.saving = true;
                    axios.post('/api/save_generated_plans', {
                        plans: this.generatedPlans,
                        mode: this.saveMode,
                        start_date: this.form.dateRange[0],
                        end_date: this.form.dateRange[1]
                    }).then(res => {
                        this.$message.success('è®¡åˆ’ä¿å­˜æˆåŠŸ');
                        this.previewDialogVisible = false;
                        this.fetchPlans(); // åˆ·æ–°å…¨å±€æ•°æ®
                    }).catch(err => {
                        this.$message.error('ä¿å­˜å¤±è´¥: ' + (err.response?.data?.error || err.message));
                    }).finally(() => {
                        this.saving = false;
                    });
                },
                getPlansForDate(day) {
                    // è¿‡æ»¤å‡ºæŒ‡å®šæ—¥æœŸçš„æ‰€æœ‰è®¡åˆ’
                    return this.plans.filter(p => p.date === day);
                },
                handleDateClick(day) {
                    this.currentDateStr = day;
                    // æ·±æ‹·è´ï¼Œé˜²æ­¢ç›´æ¥ä¿®æ”¹å½±å“åˆ—è¡¨æ˜¾ç¤º
                    this.currentPlans = JSON.parse(JSON.stringify(this.getPlansForDate(day)));
                    this.dialogVisible = true;
                },
                updatePlan(plan) {
                    axios.post('/api/update_day', plan).then(res => {
                        this.$message.success('ä¿å­˜æˆåŠŸ');
                        this.fetchPlans(); // åˆ·æ–°å…¨å±€æ•°æ®
                    }).catch(err => {
                        this.$message.error('ä¿å­˜å¤±è´¥');
                    });
                },
                deletePlan(id) {
                    this.$confirm('ç¡®è®¤åˆ é™¤è¯¥æ¡è®¡åˆ’?', 'æç¤º', {
                        confirmButtonText: 'ç¡®å®š',
                        cancelButtonText: 'å–æ¶ˆ',
                        type: 'warning'
                    }).then(() => {
                        axios.post('/api/delete_plan', { id: id }).then(res => {
                            this.$message.success('åˆ é™¤æˆåŠŸ');
                            // ä»å½“å‰å¼¹çª—åˆ—è¡¨ä¸­ç§»é™¤
                            this.currentPlans = this.currentPlans.filter(p => p.id !== id);
                            this.fetchPlans(); // åˆ·æ–°å…¨å±€æ•°æ®
                        });
                    }).catch(() => {});
                },
                logout() {
                    window.location.href = '/logout';
                }
            }
        })
    </script>
</body>
</html>